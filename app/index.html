<!DOCTYPE html>
<html>
  <head>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.js"></script>    

    <script src="build/react.js"></script>
    <script src="build/JSXTransformer.js"></script>

    <script type="text/jsx" src="datepicker.jsx"></script>

    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
    <link type="text/css" href="styles/datepicker.css" rel="stylesheet" />
    <link type="text/css" href="styles/style.css" rel="stylesheet" />
  </head>
  <body>

    <div id="container" class="container">
    </div>

    <script type="text/jsx">
    /** @jsx React.DOM */
      
      var NewApartForm = React.createClass({
          postNewApart: function(apart_id) {
            $.post("/rest/apart?apart_id=" + apart_id)
            .done(function() {
              console.log("SUCCESS");
            })
            .fail(function() {
              console.log("FAIL");
            })
          },
          handleSubmit: function(e) {
            //e.preventDefault();
            var apart_id = this.refs.apart_id.getDOMNode().value.trim();
            if (!apart_id) {
              return false;
            }
            console.log("APART ID " + apart_id);
            // post new apart
            this.postNewApart(apart_id);
            // clear form
            this.refs.apart_id.getDOMNode().value = '';
            return false;
          },
          render: function() {
            return (<form className="apartForm" onSubmit={this.handleSubmit}>
                      <input 
                        className="form-control"
                        type="text" 
                        placeholder="Nueva Referencia Apartamento Homelidays"
                        ref="apart_id" />
                      <input type="submit" value="Post" className="btn btn-primary" />
                    </form>);
          }
      });

      var Homelidays_URL = "http://www.homelidays.com/hebergement/p";
      
      var Apart = React.createClass({

          getInitialState: function() {
            return {loading: false, deleting: false};
          },

          onDelete: function() {
            this.props.onDelete(this.props.apart.id);
            this.setState({deleting: true});
          },

          onUpdate: function() {
            this.props.onUpdate(this.props.apart.id);
            this.setState({loading: true});
          },

          componentWillReceiveProps: function(nextProps) {
            this.setState({loading: false, deleting: false});
          },

          render: function() {
            var apart = this.props.apart,
                image = apart.data.property.imageUrls[0],
                apartClassName = "apart" + (this.props.isAvailable ? " available" : "");
            return (<div className={apartClassName}>
                      <img className="apart-img" src={image} />
                      <div className="apart-info">
                        <p>{apart.description}</p>
                        <a href={Homelidays_URL + apart.id} target={"_blank"}>
                          <p className="apart-id" >Referencia: {apart.id}</p>
                        </a>
                        <p>
                        <button 
                          type="button" 
                          onClick={this.onUpdate} 
                          className="btn btn-info" 
                          disabled={this.state.loading ? "disabled":""}>
                          {this.state.loading ? "actualizando...":"actualizar"}
                        </button>
                        <button 
                          type="button" 
                          onClick={this.onDelete} 
                          className="btn btn-danger"
                          disabled={this.state.deleting ? "disabled":""}>
                          {this.state.deleting ? "suprimiendo...":"suprimir"}
                        </button>
                        </p>
                      </div>
                      <MonthBar
                        period={this.props.period}
                        reservations={apart.reserved}
                        weeks={apart.data.availabilityCalendar.reservations} />
                    </div>);
          }
      });
    
      var Aparts = React.createClass({

          parseAparts: function(aparts) {
            var parsedAparts = $.parseJSON(aparts);
            $.each(parsedAparts, function(i, apart) {
                apart = this.parseApart(apart);
            }.bind(this));
            return parsedAparts;
          },

          parseApart: function(apart) {
            apart.reserved = $.parseJSON(apart.reserved);
            apart.data = $.parseJSON(apart.data);
            return apart;
          },

          getApartIndexFromID: function(apart_id) {
            var apart_index = -1;
            $.each(this.state.aparts, function(i, apart) {
              if (apart && apart.id == apart_id) {
                apart_index = i;
                return false;
              }
            });
            if (apart_index < 0) {
              console.log("apart " + apart_id + " not found");
              return;
            } else 
              return apart_index;
          },

          loadAparts: function() {
            console.log("Started loading aparts !");
            $.get("../rest/apart/list")
            .done(function(aparts) {
              this.setState({aparts: this.parseAparts(aparts)});
            }.bind(this))
            .fail(function(xhr, status, err) {
              console.error(this.props.url, status, err.toString());
            }.bind(this));
          },

          onDeleteApart: function(apart_id) {
            $.ajax({type: "DELETE", url: "/rest/apart?apart_id=" + apart_id})
            .done(function() {

              var apart_index = this.getApartIndexFromID(apart_id);
              delete this.state.aparts[apart_index];
              this.setState({aparts: this.state.aparts});

            }.bind(this))
            .fail(function(xhr, status, err) {
              console.error("error deleting apart " + apart_id, status, err.toString());
            }.bind(this));
          },

          onUpdateApart: function(apart_id) {
            $.post("/rest/apart?apart_id=" + apart_id)
            .done(function(apart) {
              
              apart = $.parseJSON(apart);
              apart = this.parseApart(apart);
              var apart_index = this.getApartIndexFromID(apart_id);
              this.state.aparts[apart_index] = apart;
              this.setState({aparts: this.state.aparts});

            }.bind(this))
            .fail(function(xhr, status, err) {
              console.error("error updating apart " + apart_id, status, err.toString());
            }.bind(this));
          },

          getInitialState: function() {
            return {aparts:[]};
          },

          componentDidMount: function() {
            this.loadAparts();
          },

          isAvailable: function(apart) {
            var start = this.props.period.start,
                end = this.props.period.end,
                weeks = apart.data.availabilityCalendar.reservations;

            var parseDate = function(dateStr) {
              var d = dateStr.split("-");
              var parsedDate = new Date();
              parsedDate.setFullYear(parseInt(d[0]));
              parsedDate.setMonth(parseInt(d[1]));
              parsedDate.setDate(parseInt(d[2]));
              parsedDate.setHours(0,0,0,0);
              return parsedDate;
            };

            var available = true;
            $.each(weeks, function(k, res) {

              var checkin = parseDate(res.checkinDate),
                  checkout = parseDate(res.checkoutDate);

              if (checkin <= start && start <= checkout) {
                available = false;
                return false;
              }

              if (checkin <= end && end <= checkout) {
                available = false;
                return false;
              }

              if (checkin <= start && checkin <= end) {
                available = false;
                return false; 
              }

              return true;
            });
            
            console.log("apart id: " + apart.id + " " + (available ? "available" : "un-available"));

            return available;
          },

          render: function() {
            var aparts = this.state.aparts.map(function(apart){
                return (<Apart
                          isAvailable={this.isAvailable(apart)}
                          onUpdate={this.onUpdateApart}
                          onDelete={this.onDeleteApart}
                          period={this.props.period}
                          apart={apart} />);
            }.bind(this));

            return (<div className="aparts">
                      {aparts}
                    </div>);
          }
      });

      var DateFilter = React.createClass({
          changeStart: function(date) {
            this.props.onChangePeriod({start: date, end: this.props.period.end});
          },
          changeEnd: function(date) {
            this.props.onChangePeriod({start: this.props.period.start, end: date});
          },
          render: function() {
            return (<form className="form-inline date-filters" role="form">
                      <div className="date-filter form-group">
                        <label className="date-picker-label">check-in</label>
                        <DatePickerInput
                          date={this.props.period.start}
                          onChangeDate={this.changeStart}/>
                      </div>
                      <div className="date-filter form-group">
                        <label className="date-picker-label">check-out</label>
                        <DatePickerInput 
                          date={this.props.period.end}
                          onChangeDate={this.changeEnd}/>
                      </div>
                    </form>);
          }
      });

      var ApartsFilter = React.createClass({

        getInitialState: function() {
          var endDate = new Date();
          var newYear = endDate.getFullYear() + 1;
          endDate.setFullYear(newYear);
          console.log(endDate);
          return {period: {start: new Date(), end: endDate}};
        },

        onChangePeriod: function(period) {
          this.setState({period: period});
        },

        render: function() {
          console.log(this.state.period);
          return (<div>
                    <DateFilter
                      period={this.state.period}
                      onChangePeriod={this.onChangePeriod}/>
                    <Aparts 
                      period={this.state.period}/>
                  </div>);
        }
      });

      React.renderComponent(
        <ApartsFilter />,
        document.getElementById('container')
      );

    </script>

  </body>
</html>