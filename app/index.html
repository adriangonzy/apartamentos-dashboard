<!DOCTYPE html>
<html>
  <head>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.js"></script>    

    <script src="build/react.js"></script>
    <script src="build/JSXTransformer.js"></script>

    <script type="text/jsx" src="datepicker.jsx"></script>

    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" />
    <link type="text/css" href="styles/datepicker.css" rel="stylesheet" />
    <link type="text/css" href="styles/style.css" rel="stylesheet" />
  </head>
  <body>

    <div id="container" class="container">
    </div>

    <script type="text/jsx">
      /** @jsx React.DOM */

      var Homelidays_URL = "http://www.homelidays.com/hebergement/p";

      var NewApartForm = React.createClass({
          postNewApart: function(apart_id) {
            $.post("/rest/apart?apart_id=" + apart_id)
            .done(function(data) {
              console.log("SUCCESS");
            })
            .fail(function(data) {
              console.log("FAIL");
            })
          },
          handleSubmit: function(e) {
            //e.preventDefault();
            var apart_id = this.refs.apart_id.getDOMNode().value.trim();
            if (!apart_id) {
              return false;
            }
            console.log("APART ID " + apart_id);
            // post new apart
            this.postNewApart(apart_id);
            // clear form
            this.refs.apart_id.getDOMNode().value = '';
            return false;
          },
          render: function() {
            return (
              <form className="apartForm" onSubmit={this.handleSubmit}>
                <input 
                  className="form-control"
                  type="text" 
                  placeholder="Nueva Referencia Apartamento Homelidays"
                  ref="apart_id" />
                <input type="submit" value="Post" className="btn btn-primary" />
              </form>
            );
          }
      });
      
      var Apart = React.createClass({

          getInitialState: function() {
            return {reservations:{}};
          },

          render: function() {
            var apart = this.props.apart,
                image = apart.data.property.imageUrls[0];
            return (<div className="apart">
                      <img className="apart-img" src={image} />
                      <div className="apart-info">
                        <p>{apart.description}</p>
                        <a href={Homelidays_URL + apart.id} target={"_blank"}>
                          <p className="apart-id" >Referencia: {apart.id}</p>
                        </a>
                      </div>
                      <MonthBar
                        period={this.props.period}
                        reservations={apart.reserved} />
                    </div>);
          }
      });
    
      var Aparts = React.createClass({

          loadAparts: function() {
            console.log("Started loading aparts !");
            $.get("../rest/apart/list")
            .done(function(aparts) {
              this.setState({aparts: this.parseAparts(aparts)});
            }.bind(this))
            .fail(function(xhr, status, err) {
                console.error(this.props.url, status, err.toString());
            }.bind(this));
          },

          parseAparts: function(aparts) {
            var parsedAparts = $.parseJSON(aparts);
            $.each(parsedAparts, function(i, apart) {
                apart.reserved = $.parseJSON(apart.reserved);
                apart.data = $.parseJSON(apart.data);
            });
            return parsedAparts;
          },

          getInitialState: function() {
            return {aparts:[]};
          },

          componentDidMount: function() {
            this.loadAparts();
          },

          render: function() {
            var aparts = this.state.aparts.map(function(apart){
                return (<Apart 
                          period={this.props.period}
                          apart={apart} />);
            }.bind(this));

            return (<div className="aparts">
                      {aparts}
                    </div>);
          }
      });

      var DateFilter = React.createClass({
          changeStart: function(date) {
            this.props.onChangePeriod({start: date, end: this.props.period.end});
          },
          changeEnd: function(date) {
            this.props.onChangePeriod({start: this.props.period.start, end: date});
          },
          render: function() {
            return (<form className="form-inline date-filters" role="form">
                      <div className="date-filter form-group">
                        <label className="date-picker-label">check-in</label>
                        <DatePickerInput
                          date={this.props.period.start}
                          onChangeDate={this.changeStart}/>
                      </div>
                      <div className="date-filter form-group">
                        <label className="date-picker-label">check-out</label>
                        <DatePickerInput 
                          date={this.props.period.end}
                          onChangeDate={this.changeEnd}/>
                      </div>
                    </form>);
          }
      });

      var ApartsFilter = React.createClass({

        getInitialState: function() {
          var endDate = new Date();
          var newYear = endDate.getFullYear() + 1;
          endDate.setFullYear(newYear);
          console.log(endDate);
          return {period: {start: new Date(), end: endDate}};
        },

        onChangePeriod: function(period) {
          this.setState({period: period});
        },

        render: function() {
          console.log(this.state.period);
          return (<div>
                    <DateFilter
                      period={this.state.period}
                      onChangePeriod={this.onChangePeriod}/>
                    <Aparts 
                      period={this.state.period}/>
                  </div>);
        }
      });

      React.renderComponent(
        <ApartsFilter />,
        document.getElementById('container')
      );

    </script>

  </body>
</html>